# CLAUDE.md - Agents UI Components Guide

## Code description

This library works along with a backend which lets the user do two things:

### "query-data"

Executes quick, direct SQL queries to retrieve specific data points with minimal processing. Also called an "analysis" (note that this is not the same as oracle analysis). File useful files here are analysisManager.js and analysisTreeManager.js. Analysis can have follow on analyses, called "children", and hence can be put into trees. That is what anlaysisTreeManager.js is for. analysisManager handles a single analysis and it's whole workflow.

### reports

Performs in-depth analysis, synthesizing multiple data sources to generate comprehensive insights and structured reports. Generates reports.

Both the above are generated by selecting a "project name" and typing in a question. The question is then sent to an LLM, which may or may not choose to ask clarification questions. Once those are answered, the LLM can generate a report or an analysis (simple SQL query on the database).

The OracleEmbed component is the central UI which lets the use do both "query-data" and "reports" in a single place. The core controller of that UI is OracleSearchBar and oracleSearchBarManager. The search bar has a dropdown to select the two "modes": Fast data analysis (aka query data aka sql gen) and deep research (report).

## Detailed Architecture

### Core Functionality

1. **Query Data ("Fast Analysis")**

   - Quick SQL queries to retrieve specific data points with minimal processing
   - Managed by `analysisManager.ts` and `analysisTreeManager.ts`
   - Creates analyses that can have "children" (follow-up analyses) in a tree structure
   - Results displayed as tables or visualized as charts

2. **Oracle Reports ("Deep Research")**
   - In-depth analysis that synthesizes multiple data sources
   - Generates comprehensive insights and structured reports
   - More thorough than the Query Data feature

Both features share a common workflow:

- User selects a database name or uploads CSV/Excel files
- User types a question
- The LLM may ask clarification questions
- After clarifications, the system generates either a SQL query or a report

### Key Components

#### OracleEmbed

- Central UI component integrating both Query Data and Reports functionality
- Contains sidebar for Project selection and history navigation
- Renders different UI based on selected item type (report or analysis)

#### OracleSearchBar

- Main input interface for user questions
- Supports two modes: "Fast analysis" and "Deep research"
- Includes file upload functionality for CSV/Excel/PDF files

#### AnalysisTreeManager

- Manages hierarchical structures of analyses
- Handles parent-child relationships between analyses
- Provides functions for creating, updating, and navigating analysis trees

#### AnalysisAgent

- Renders individual analysis components
- Manages the analysis lifecycle including clarification and result display

#### AnalysisTreeContent

- Renders a tree of analyses without the sidebar or search bar
- Used within OracleEmbed to display analysis results

### Data Structures

#### OracleHistoryItem

A union type that represents items in the history sidebar:

- OracleReportType: Deep research reports
- QueryDataTree: Fast analysis SQL queries

#### QueryDataTree

- `date_created`: Timestamp string
- `itemId`: Root analysis ID
- `analysisTree`: Tree of analyses

#### AnalysisTree

Hierarchical structure representing related analyses:

```typescript
{
  [analysisId: string]: {
    root: AnalysisTreeItem;
    analysisList: AnalysisTreeItem[];
  }
}
```

### Type System

- Uses TypeScript for strong typing
- Important interfaces:
  - AnalysisTreeItem: Core data structure for analyses
  - AnalysisManager: Handles analysis lifecycle
  - AnalysisTreeManager: Manages trees of related analyses

### Contexts

- OracleEmbedContext: Provides token, API endpoint, and searchBarManager
- QueryDataEmbedContext: Provides configuration for Query Data components
- MessageManagerContext: Handles notifications and messages

### Component Communication Pattern

- Uses manager objects (AnalysisManager, AnalysisTreeManager) for state management
- Implements publisher-subscriber pattern with subscribe/unsubscribe functions
- Uses React Context for dependency injection

## Build Commands

- `pnpm dev` - Start development server
- `pnpm build` - Build for production
- `pnpm format` - Run Prettier for code formatting and linting
- `pnpm storybook` - Run Storybook for component docs

## Formatting

- Run `pnpm format` after every change to ensure consistent code formatting with Prettier

## Test Commands

- `npx playwright test` - Run all tests headlessly
- `npx playwright test --headed` - Run tests with visible browser
- `npx playwright test path/to/test.spec.ts` - Run specific test file
- `npx playwright test --ui` - Open Playwright UI for manual testing

## Code Style Guidelines

- **TypeScript**: Use strict typing when possible (strict mode enabled)
- **React**: Functional components with hooks preferred over class components
- **Naming**: PascalCase for components, camelCase for variables/functions
- **Components**: Keep components small and focused on a single responsibility
- **Imports**: Group imports by type (React, libraries, local components, styles)
- **File Organization**: Group related components in feature-based directories
- **Error Handling**: Use proper error boundaries and fallbacks
- **CSS**: Use SCSS and Tailwind for styling with consistent naming conventions
- **Testing**: Write meaningful tests that verify component behavior

## Export Pattern

Components should be exported properly via entry points in the lib directory
to ensure they can be imported by consumers via the package exports.

## Type Safety Considerations

- When working with union types like OracleHistoryItem, use type checks like `'report_id' in item` to ensure type safety
- QueryDataEmbedContext requires specific properties for proper component rendering
- Use proper error handling for API requests and component state management
